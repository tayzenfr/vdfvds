<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>formulaire verification VTU</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style>
        * { box-sizing: border-box; }
        body {
            font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
            margin: 0;
            padding: 0;
            background: #0f172a;
            color: #e5e7eb;
        }
        header {
            background: linear-gradient(135deg, #16a34a, #22c55e);
            padding: 1.7rem 1rem;
            text-align: center;
            color: white;
        }
        h1 { margin: 0; font-size: 1.9rem; }

        main {
            max-width: 1100px;
            margin: 1.5rem auto 3rem;
            padding: 0 1rem;
        }

        form {
            background: #020617;
            border-radius: .9rem;
            padding: 1.5rem 1.2rem;
            box-shadow: 0 10px 30px rgba(0,0,0,.5);
            border: 1px solid #1f2937;
        }
        fieldset {
            border: 1px solid #1f2937;
            border-radius: .7rem;
            margin-bottom: 1.4rem;
            padding: 1.1rem 1.1rem 1rem;
        }
        legend {
            padding: 0 .5rem;
            font-weight: 600;
            color: #22c55e;
            font-size: 1rem;
        }

        .grid-2 {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(230px, 1fr));
            gap: 1.1rem;
        }

        label {
            font-size: .95rem;
            display: block;
            margin-bottom: .35rem;
            color: #9ca3af;
        }

        input[type="text"],
        input[type="date"],
        textarea {
            width: 100%;
            padding: .7rem .75rem;
            border-radius: .55rem;
            border: 1px solid #374151;
            background: #020617;
            color: #e5e7eb;
            font-size: 1rem;
        }
        textarea { min-height: 80px; resize: vertical; }

        .item-row {
            display: grid;
            grid-template-columns: minmax(0, 1.7fr) minmax(0, 1.5fr) minmax(0, 1.5fr);
            gap: .85rem;
            align-items: center;
            padding: .55rem .6rem;
            border-radius: .7rem;
            background: #020617;
            border: 1px solid #111827;
            margin-bottom: .55rem;
        }
        .item-name {
            font-size: .95rem;
            font-weight: 500;
        }

        .etat-group {
            display: flex;
            flex-wrap: wrap;
            gap: .45rem;
            font-size: .9rem;
        }
        .etat-group label {
            margin-bottom: 0;
            display: inline-flex;
            align-items: center;
            gap: .35rem;
            padding: .4rem .8rem;
            border-radius: 999px;
            border: 1px solid #374151;
            background: #020617;
        }
        .etat-group input[type="radio"] {
            transform: scale(1.3);
        }

        .small-input {
            font-size: .9rem;
            padding: .5rem .6rem;
            border-radius: .5rem;
            border: 1px solid #374151;
            background: #020617;
            color: #e5e7eb;
            width: 100%;
        }

        .actions {
            display: flex;
            flex-wrap: wrap;
            gap: .85rem;
            margin-top: 1.2rem;
        }
        button {
            border: none;
            border-radius: .65rem;
            padding: .8rem 1.3rem;
            font-weight: 600;
            cursor: pointer;
            font-size: 1rem;
        }
        button[type="submit"] {
            background: #22c55e;
            color: #052e16;
        }
        button.secondary {
            background: #111827;
            color: #e5e7eb;
            border: 1px solid #1f2937;
        }

        @media (max-width: 900px) {
            main { padding: 0 .6rem; }
            form { padding: 1.2rem .9rem; }
            .item-row {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
<header>
    <h1>formulaire verification VTU</h1>
</header>

<main>
    <form id="inventaireForm">
        <fieldset>
            <legend>Informations g√©n√©rales</legend>
            <div class="grid-2">
                <div>
                    <label for="date">Date du contr√¥le</label>
                    <input type="date" id="date" name="date" required>
                </div>
                <div>
                    <label for="conducteur">NOM, pr√©nom</label>
                    <input type="text" id="conducteur" name="conducteur" placeholder="Nom, pr√©nom" required>
                </div>
            </div>
        </fieldset>

        <fieldset>
            <legend>Mat√©riel VTU</legend>
            <p style="font-size:.9rem;color:#9ca3af;margin-top:0;">
                Pour chaque mat√©riel : <strong>Pr√©sent</strong>, <strong>Manquant</strong> ou <strong>HS</strong>.
            </p>
            <div id="itemsContainer"></div>
        </fieldset>

        <fieldset>
            <legend>Observation g√©n√©rale</legend>
            <label for="observations">Observation g√©n√©rale</label>
            <textarea id="observations" name="observations"></textarea>
        </fieldset>

        <div class="actions">
            <button type="submit">Exporter et envoyer</button>
            <button type="button" class="secondary" id="resetFormBtn">R√©initialiser</button>
        </div>
    </form>
</main>

<script>
    const EMAIL_TO = "charpentreaupascal@gmail.com";

    const MATERIAL_ITEMS = [
        "Aspirateur √† eau et chariot","Bidon carburant x4","Paire de botte","Commande","C√¥nes x2",
        "Cuissardes x4","Dagueuse","√âmulseur x4","Lit picot","Lot ANIM","Moto pompe thermique",
        "Groupe √©lectrog√®ne","Pompe √©lectrique","Poubelle","Projecteur portable x2",
        "Raclettes x2 grande et moyenne","Tuyaux diam√®tre 70 x10","Tuyaux diam√®tre 45 x4",
        "Tuyaux diam√®tre 100","Tuyaux Barcelona x5","Tuyaux d'aspiration x4","Caisses d'√©puisement",
        "Polycose","Bouteille plastique","Flotteur","Cr√©pine","Cl√© de poteau","Lance 45 x2",
        "R√©duction 70/45","Pioche","Cl√© de barrage","Sac absorbant","Cales x2","Tuyaux LDT x3",
        "Une masse","Raccord de r√©duction 70/40","LSPCC + commande","Rallonge √©lectrique",
        "Raccord 110/70","Cage √† chat","Couverture","Caisse en polystyr√®ne","Pince reptile",
        "Crochets x2","√âchelle t√©lescopique"
    ];

    function slug(str) {
        return str.toLowerCase()
            .normalize("NFD").replace(/[\u0300-\u036f]/g, "")
            .replace(/[^a-z0-9]+/g, "_")
            .replace(/^_+|_+$/g, "");
    }

    function renderItemRows() {
        const container = document.getElementById("itemsContainer");
        container.innerHTML = "";
        MATERIAL_ITEMS.forEach(label => {
            const id = "item_" + slug(label);
            container.insertAdjacentHTML("beforeend", `
                <div class="item-row" data-item="${label}" data-group="${id}">
                    <div class="item-name">${label}</div>
                    <div class="etat-group">
                        <label><input type="radio" name="${id}" value="OK"> Pr√©sent</label>
                        <label><input type="radio" name="${id}" value="Manquant"> Manquant</label>
                        <label><input type="radio" name="${id}" value="HS"> HS</label>
                    </div>
                    <div><input class="small-input" type="text" placeholder="Observation"></div>
                </div>
            `);
        });
    }

    function buildItems() {
        const items = [];
        document.querySelectorAll(".item-row").forEach(row => {
            const item = row.dataset.item;
            const group = row.dataset.group;
            const checked = document.querySelector(`input[name="${group}"]:checked`);
            const etat = checked ? checked.value : "Non renseign√©";
            const obs = row.querySelector("input[type=text]").value.trim();
            items.push({ item, etat, obs });
        });
        return items;
    }

    function exportCSV(record) {
        let rows = ["date;agent;item;etat;remarque;obsGenerale"];
        record.items.forEach(it => {
            rows.push([
                record.date,
                record.conducteur,
                it.item,
                it.etat,
                it.obs.replace(/;/g, ","),
                record.observations.replace(/;/g, ",")
            ].join(";"));
        });

        const blob = new Blob([rows.join("\n")], { type: "text/csv;charset=utf-8;" });
        const url = URL.createObjectURL(blob);
        const fileName = `controle_vtu_${record.date}.csv`;

        const a = document.createElement("a");
        a.href = url;
        a.download = fileName;
        document.body.appendChild(a);
        a.click();
        a.remove();
        URL.revokeObjectURL(url);
    }

    function openEmail(record) {
        const subject = encodeURIComponent(`Contr√¥le VTU du ${record.date} ‚Äì ${record.conducteur}`);

        const body = encodeURIComponent(
`Bonjour,

Le contr√¥le VTU du ${record.date} a √©t√© effectu√© par ${record.conducteur}.

‚ö†Ô∏è IMPORTANT : le fichier du contr√¥le a √©t√© t√©l√©charg√© sur cet ordinateur.
Avant d'envoyer cet e-mail, veuillez :

1) Cliquer sur "Joindre un fichier" dans Gmail.
2) S√©lectionner le fichier CSV nomm√© :
   controle_vtu_${record.date}.csv
3) V√©rifier le contenu, puis cliquer sur "Envoyer".

Observation g√©n√©rale :
${record.observations || "RAS"}

Cordialement.`
        );

        // üëâ Ouvre le client mail / Gmail
        window.location.href = `mailto:${EMAIL_TO}?subject=${subject}&body=${body}`;
    }

    document.getElementById("inventaireForm").addEventListener("submit", e => {
        e.preventDefault();

        const record = {
            date: e.target.date.value,
            conducteur: e.target.conducteur.value.trim(),
            observations: e.target.observations.value.trim(),
            items: buildItems()
        };

        if (!record.date || !record.conducteur) {
            alert("Merci de remplir la date et le nom.");
            return;
        }

        const ok = confirm(
"En cliquant sur OK :\n\n" +
"- Un fichier CSV du contr√¥le VTU va √™tre t√©l√©charg√© sur cet ordinateur.\n" +
"- Tu seras ensuite redirig√© vers la messagerie (ex : Gmail).\n\n" +
"Dans l'e-mail, il faudra JOINDRE le fichier CSV avant d'envoyer."
        );
        if (!ok) return;

        // 1) T√©l√©chargement du fichier CSV
        exportCSV(record);

        // 2) Ouverture de l'e-mail vers charpentreaupascal@gmail.com
        openEmail(record);
    });

    document.getElementById("resetFormBtn").addEventListener("click", () => {
        if (confirm("R√©initialiser le formulaire ?")) {
            document.getElementById("inventaireForm").reset();
        }
    });

    (function init() {
        renderItemRows();
        const today = new Date().toISOString().slice(0, 10);
        document.getElementById("date").value = today;
    })();
</script>

</body>
</html>
