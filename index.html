<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>formulaire verification VTU</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style>
        * { box-sizing: border-box; }
        body {
            font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
            margin: 0;
            padding: 0;
            background: #0f172a;
            color: #e5e7eb;
        }
        header {
            background: linear-gradient(135deg, #16a34a, #22c55e);
            padding: 1.7rem 1rem;
            text-align: center;
            color: white;
        }
        h1 { margin: 0; font-size: 1.9rem; }

        main {
            max-width: 1100px;
            margin: 1.5rem auto 3rem;
            padding: 0 1rem;
        }

        form {
            background: #020617;
            border-radius: .9rem;
            padding: 1.5rem 1.2rem;
            box-shadow: 0 10px 30px rgba(0,0,0,.5);
            border: 1px solid #1f2937;
        }
        fieldset {
            border: 1px solid #1f2937;
            border-radius: .7rem;
            margin-bottom: 1.4rem;
            padding: 1.1rem 1.1rem 1rem;
        }
        legend {
            padding: 0 .5rem;
            font-weight: 600;
            color: #22c55e;
            font-size: 1rem;
        }

        .grid-2 {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(230px, 1fr));
            gap: 1.1rem;
        }

        label {
            font-size: .95rem;
            display: block;
            margin-bottom: .35rem;
            color: #9ca3af;
        }

        input[type="text"],
        input[type="date"],
        textarea {
            width: 100%;
            padding: .7rem .75rem;
            border-radius: .55rem;
            border: 1px solid #374151;
            background: #020617;
            color: #e5e7eb;
            font-size: 1rem;
        }
        textarea { min-height: 80px; resize: vertical; }

        .item-row {
            display: grid;
            grid-template-columns: minmax(0, 1.7fr) minmax(0, 1.5fr) minmax(0, 1.5fr);
            gap: .85rem;
            align-items: center;
            padding: .55rem .6rem;
            border-radius: .7rem;
            background: #020617;
            border: 1px solid #111827;
            margin-bottom: .55rem;
        }
        .item-name {
            font-size: .95rem;
            font-weight: 500;
        }

        .etat-group {
            display: flex;
            flex-wrap: wrap;
            gap: .45rem;
            font-size: .9rem;
        }
        .etat-group label {
            margin-bottom: 0;
            display: inline-flex;
            align-items: center;
            gap: .35rem;
            padding: .4rem .8rem;
            border-radius: 999px;
            border: 1px solid #374151;
            background: #020617;
        }
        .etat-group input[type="radio"] {
            transform: scale(1.3);
        }

        .small-input {
            font-size: .9rem;
            padding: .5rem .6rem;
            border-radius: .5rem;
            border: 1px solid #374151;
            background: #020617;
            color: #e5e7eb;
            width: 100%;
        }

        .actions {
            display: flex;
            flex-wrap: wrap;
            gap: .85rem;
            margin-top: 1.2rem;
        }
        button {
            border: none;
            border-radius: .65rem;
            padding: .8rem 1.3rem;
            font-weight: 600;
            cursor: pointer;
            font-size: 1rem;
        }
        button[type="submit"] {
            background: #22c55e;
            color: #052e16;
        }
        button.secondary {
            background: #111827;
            color: #e5e7eb;
            border: 1px solid #1f2937;
        }

        @media (max-width: 900px) {
            main { padding: 0 .6rem; }
            form { padding: 1.2rem .9rem; }
            .item-row {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
<header>
    <h1>formulaire verification VTU</h1>
</header>

<main>
    <form id="inventaireForm">
        <fieldset>
            <legend>Informations générales</legend>
            <div class="grid-2">
                <div>
                    <label for="date">Date du contrôle</label>
                    <input type="date" id="date" name="date" required>
                </div>
                <div>
                    <label for="conducteur">NOM, prénom</label>
                    <input type="text" id="conducteur" name="conducteur" placeholder="Nom, prénom" required>
                </div>
            </div>
        </fieldset>

        <fieldset>
            <legend>Matériel VTU</legend>
            <p style="font-size:.9rem;color:#9ca3af;margin-top:0;">
                Pour chaque matériel : <strong>Présent</strong>, <strong>Manquant</strong> ou <strong>HS</strong>.
            </p>
            <div id="itemsContainer"></div>
        </fieldset>

        <fieldset>
            <legend>Observation générale</legend>
            <label for="observations">Observation générale</label>
            <textarea id="observations" name="observations"></textarea>
        </fieldset>

        <div class="actions">
            <button type="submit">Exporter et envoyer</button>
            <button type="button" class="secondary" id="resetFormBtn">Réinitialiser</button>
        </div>
    </form>
</main>

<script>
    const EMAIL_TO = "charpentreaupascal@gmail.com";

    const MATERIAL_ITEMS = [
        "Aspirateur à eau et chariot","Bidon carburant x4","Paire de botte","Commande","Cônes x2",
        "Cuissardes x4","Dagueuse","Émulseur x4","Lit picot","Lot ANIM","Moto pompe thermique",
        "Groupe électrogène","Pompe électrique","Poubelle","Projecteur portable x2",
        "Raclettes x2 grande et moyenne","Tuyaux diamètre 70 x10","Tuyaux diamètre 45 x4",
        "Tuyaux diamètre 100","Tuyaux Barcelona x5","Tuyaux d'aspiration x4","Caisses d'épuisement",
        "Polycose","Bouteille plastique","Flotteur","Crépine","Clé de poteau","Lance 45 x2",
        "Réduction 70/45","Pioche","Clé de barrage","Sac absorbant","Cales x2","Tuyaux LDT x3",
        "Une masse","Raccord de réduction 70/40","LSPCC + commande","Rallonge électrique",
        "Raccord 110/70","Cage à chat","Couverture","Caisse en polystyrène","Pince reptile",
        "Crochets x2","Échelle télescopique"
    ];

    function slug(str) {
        return str.toLowerCase()
            .normalize("NFD").replace(/[\u0300-\u036f]/g, "")
            .replace(/[^a-z0-9]+/g, "_")
            .replace(/^_+|_+$/g, "");
    }

    function renderItemRows() {
        const container = document.getElementById("itemsContainer");
        MATERIAL_ITEMS.forEach(label => {
            const id = "item_" + slug(label);
            container.insertAdjacentHTML("beforeend", `
                <div class="item-row" data-item="${label}" data-group="${id}">
                    <div class="item-name">${label}</div>
                    <div class="etat-group">
                        <label><input type="radio" name="${id}" value="OK"> Présent</label>
                        <label><input type="radio" name="${id}" value="Manquant"> Manquant</label>
                        <label><input type="radio" name="${id}" value="HS"> HS</label>
                    </div>
                    <div><input class="small-input" type="text" placeholder="Observation"></div>
                </div>
            `);
        });
    }

    function buildItems() {
        const items = [];
        document.querySelectorAll(".item-row").forEach(row => {
            const item = row.dataset.item;
            const group = row.dataset.group;
            const checked = document.querySelector(`input[name="${group}"]:checked`);
            const etat = checked ? checked.value : "Non renseigné";
            const obs = row.querySelector("input[type=text]").value.trim();
            items.push({ item, etat, obs });
        });
        return items;
    }

    function exportCSV(record) {
        let rows = ["date;agent;item;etat;remarque;obsGenerale"];
        record.items.forEach(it => {
            rows.push([
                record.date,
                record.conducteur,
                it.item,
                it.etat,
                it.obs.replace(/;/g, ","),
                record.observations.replace(/;/g, ",")
            ].join(";"));
        });

        const blob = new Blob([rows.join("\n")], { type: "text/csv;charset=utf-8;" });
        const url = URL.createObjectURL(blob);
        const fileName = `controle_vtu_${record.date}.csv`;

        const a = document.createElement("a");
        a.href = url;
        a.download = fileName;
        document.body.appendChild(a);
        a.click();
        a.remove();
        URL.revokeObjectURL(url);
    }

    function openEmail(record) {
        const subject = encodeURIComponent(`Contrôle VTU du ${record.date} – ${record.conducteur}`);
        
        const body = encodeURIComponent(
`Bonjour,

Le contrôle VTU du ${record.date} a été effectué par ${record.conducteur}.

⚠️ IMPORTANT :
Merci de joindre le fichier CSV téléchargé avant d’envoyer cet e-mail.

Observation générale :
${record.observations || "RAS"}

Cordialement.`
        );

        window.location.href = `mailto:${EMAIL_TO}?subject=${subject}&body=${body}`;
    }

    document.getElementById("inventaireForm").addEventListener("submit", e => {
        e.preventDefault();

        const record = {
            date: e.target.date.value,
            conducteur: e.target.conducteur.value.trim(),
            observations: e.target.observations.value.trim(),
            items: buildItems()
        };

        if (!record.date || !record.conducteur) {
            alert("Merci de remplir la date et le nom.");
            return;
        }

        exportCSV(record);
        openEmail(record);
    });

    document.getElementById("resetFormBtn").addEventListener("click", () => {
        if (confirm("Réinitialiser le formulaire ?")) {
            document.getElementById("inventaireForm").reset();
        }
    });

    renderItemRows();
</script>
</body>
</html>
